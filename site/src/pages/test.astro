---
import Layout from '../layouts/Layout.astro';
---

<Layout
	title="ë‚˜ì—ê²Œ ë”±! ë§ëŠ” BEE ê²¨ìš¸ íŠ¹ê°• ê³¼ëª©ì€? | BEE ê³¼ëª©ì°¾ê¸° í…ŒìŠ¤íŠ¸"
	description="ë‚˜ë§Œì˜ í•™ìŠµ ìŠ¤íƒ€ì¼ì— ë”± ë§ëŠ” ì„±ê²½ ê³µë¶€ ê³¼ëª©ì„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤."
	image="/test-preview.png"
>
	<!-- Loading Screen -->
	<div id="loading-screen" class="fixed inset-0 flex items-center justify-center transition-opacity duration-700" style="z-index: 9999;">
		<div class="flex flex-col items-center justify-center">
			<!-- Animated crayon drawing effect -->
			<svg width="120" height="120" viewBox="0 0 120 120" style="margin-bottom: 1.5rem; display: block; margin-left: auto; margin-right: auto;">
				<circle cx="60" cy="60" r="50" fill="none" stroke="#6FA8DC" stroke-width="4" stroke-dasharray="314" stroke-dashoffset="314" stroke-linecap="round" style="animation: draw 2s ease-out forwards;">
					<animate attributeName="stroke-dashoffset" from="314" to="0" dur="2s" fill="freeze" />
				</circle>
				<circle cx="60" cy="60" r="35" fill="none" stroke="#8AB4E5" stroke-width="3" stroke-dasharray="220" stroke-dashoffset="220" stroke-linecap="round" style="animation-delay: 0.5s;">
					<animate attributeName="stroke-dashoffset" from="220" to="0" dur="1.5s" begin="0.5s" fill="freeze" />
				</circle>
			</svg>
			<p class="text-base md:text-xl" style="font-family: 'Ongeullip Cocoa'; font-weight: 700; color: #6FA8DC; animation: fadeIn 1s ease-out; text-align: center; width: 100%;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
		</div>
	</div>

	<div class="min-h-screen p-4 overflow-auto" style="opacity: 0; position: relative;" id="main-content">
		<!-- Decorative elements -->
		<div style="position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden;">
			<!-- Atom structure -->
			<svg class="hidden md:block" style="position: absolute; top: 10%; left: 10%; width: 85px; height: 85px; animation: slowRotate 35s linear infinite;">
				<ellipse cx="42.5" cy="42.5" rx="32" ry="13" fill="none" stroke="#FFD700" stroke-width="2.5" transform="rotate(0 42.5 42.5)" style="filter: url(#crayon-texture);"/>
				<ellipse cx="42.5" cy="42.5" rx="32" ry="13" fill="none" stroke="#6FA8DC" stroke-width="2.5" transform="rotate(60 42.5 42.5)" style="filter: url(#crayon-texture);"/>
				<ellipse cx="42.5" cy="42.5" rx="32" ry="13" fill="none" stroke="#FF6B9D" stroke-width="2.5" transform="rotate(120 42.5 42.5)" style="filter: url(#crayon-texture);"/>
				<circle cx="42.5" cy="42.5" r="6" fill="#4285F4"/>
			</svg>

			<!-- Striped circle (top center) -->
			<svg style="position: absolute; top: 8%; left: 50%; transform: translateX(-50%); width: 50px; height: 50px; animation: slowRotate 28s linear infinite reverse;">
				<circle cx="25" cy="25" r="20" fill="none" stroke="#FFD700" stroke-width="2.5" style="filter: url(#crayon-texture);"/>
				<line x1="11" y1="13" x2="18" y2="20" stroke="#FFD700" stroke-width="2.5" stroke-linecap="round" style="filter: url(#crayon-texture);"/>
				<line x1="15" y1="11" x2="22" y2="18" stroke="#FFD700" stroke-width="2.5" stroke-linecap="round" style="filter: url(#crayon-texture);"/>
				<line x1="19" y1="9" x2="26" y2="16" stroke="#FFD700" stroke-width="2.5" stroke-linecap="round" style="filter: url(#crayon-texture);"/>
			</svg>

			<!-- Rocket (bottom left) -->
			<svg class="hidden md:block" style="position: absolute; bottom: 15%; left: 8%; width: 50px; height: 60px; animation: floatSlow1 8s ease-in-out infinite;">
				<path d="M25,10 L30,35 L20,35 Z" fill="#6FA8DC" stroke="#6FA8DC" stroke-width="2" style="filter: url(#crayon-texture);"/>
				<rect x="20" y="32" width="10" height="15" fill="#6FA8DC" stroke="#6FA8DC" stroke-width="2" style="filter: url(#crayon-texture);"/>
				<path d="M18,45 L15,52 L20,47 Z" fill="#FF6B9D" stroke="#FF6B9D" stroke-width="1.5" style="filter: url(#crayon-texture);"/>
				<path d="M32,45 L35,52 L30,47 Z" fill="#FF6B9D" stroke="#FF6B9D" stroke-width="1.5" style="filter: url(#crayon-texture);"/>
				<circle cx="25" cy="25" r="3" fill="#FFF"/>
			</svg>

			<!-- Droplets/teardrops -->
			<svg style="position: absolute; top: 20%; right: 20%; width: 20px; height: 25px; animation: floatSlow2 6s ease-in-out infinite;">
				<path d="M10,5 Q15,12 15,18 Q15,22 10,22 Q5,22 5,18 Q5,12 10,5 Z" fill="#6FA8DC" stroke="#6FA8DC" stroke-width="1.5" style="filter: url(#crayon-texture);"/>
			</svg>
			<svg style="position: absolute; top: 45%; left: 18%; width: 18px; height: 23px; animation: floatGentle 7s ease-in-out infinite;">
				<path d="M9,5 Q13,11 13,16 Q13,20 9,20 Q5,20 5,16 Q5,11 9,5 Z" fill="#6FA8DC" stroke="#6FA8DC" stroke-width="1.5" style="filter: url(#crayon-texture);"/>
			</svg>

			<!-- Hearts (scattered) -->
			<svg style="position: absolute; top: 15%; right: 10%; width: 35px; height: 35px; animation: floatSlow1 7s ease-in-out infinite;">
				<path d="M17,30 Q10,22 6,14 Q2,6 10,6 Q14,6 17,10 Q20,6 24,6 Q32,6 28,14 Q24,22 17,30 Z" fill="none" stroke="#FFD700" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="filter: url(#crayon-texture);"/>
			</svg>
			<svg class="hidden md:block" style="position: absolute; top: 55%; left: 6%; width: 32px; height: 32px; animation: floatSlow2 9s ease-in-out infinite;">
				<path d="M16,28 Q9,20 6,13 Q2,5 9,5 Q13,5 16,9 Q19,5 23,5 Q30,5 26,13 Q23,20 16,28 Z" fill="none" stroke="#6FA8DC" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="filter: url(#crayon-texture);"/>
			</svg>
			<svg style="position: absolute; bottom: 28%; right: 12%; width: 28px; height: 28px; animation: floatGentle 8s ease-in-out infinite;">
				<path d="M14,24 Q8,17 5,11 Q2,4 8,4 Q11,4 14,7 Q17,4 20,4 Q26,4 23,11 Q20,17 14,24 Z" fill="none" stroke="#FF6B9D" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="filter: url(#crayon-texture);"/>
			</svg>
			<svg class="hidden md:block" style="position: absolute; top: 18%; left: 15%; width: 30px; height: 30px; animation: floatGentle 9s ease-in-out infinite;">
				<path d="M15,26 Q9,19 6,12 Q2,5 9,5 Q12,5 15,8 Q18,5 21,5 Q28,5 24,12 Q21,19 15,26 Z" fill="none" stroke="#FF6B9D" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="filter: url(#crayon-texture);"/>
			</svg>

			<!-- Triangles -->
			<svg style="position: absolute; bottom: 35%; left: 10%; width: 32px; height: 32px; animation: floatGentle 10s ease-in-out infinite;">
				<path d="M16,5 L30,27 L2,27 Z" fill="none" stroke="#FF6B9D" stroke-width="2.5" stroke-linejoin="round" style="filter: url(#crayon-texture);"/>
			</svg>
			<svg class="hidden md:block" style="position: absolute; top: 12%; right: 18%; width: 28px; height: 28px; animation: floatSlow2 11s ease-in-out infinite;">
				<path d="M14,5 L26,24 L2,24 Z" fill="#FFD700" stroke="#FFD700" stroke-width="2.5" stroke-linejoin="round" style="filter: url(#crayon-texture);"/>
			</svg>
			<svg class="hidden md:block" style="position: absolute; top: 20%; left: 25%; width: 26px; height: 26px; animation: floatSlow1 10s ease-in-out infinite;">
				<path d="M13,5 L24,22 L2,22 Z" fill="none" stroke="#6FA8DC" stroke-width="2.5" stroke-linejoin="round" style="filter: url(#crayon-texture);"/>
			</svg>

			<!-- Striped circle -->
			<svg class="hidden md:block" style="position: absolute; top: 35%; right: 8%; width: 48px; height: 48px; animation: slowRotate 25s linear infinite;">
				<circle cx="24" cy="24" r="19" fill="none" stroke="#6FA8DC" stroke-width="2.5" style="filter: url(#crayon-texture);"/>
				<line x1="11" y1="13" x2="17" y2="19" stroke="#6FA8DC" stroke-width="2.5" stroke-linecap="round" style="filter: url(#crayon-texture);"/>
				<line x1="15" y1="11" x2="21" y2="17" stroke="#6FA8DC" stroke-width="2.5" stroke-linecap="round" style="filter: url(#crayon-texture);"/>
				<line x1="19" y1="9" x2="25" y2="15" stroke="#6FA8DC" stroke-width="2.5" stroke-linecap="round" style="filter: url(#crayon-texture);"/>
			</svg>

			<!-- Cylinder with stripes -->
			<svg class="hidden md:block" style="position: absolute; top: 48%; left: 20%; width: 55px; height: 38px; animation: floatGentle 11s ease-in-out infinite;">
				<ellipse cx="27.5" cy="19" rx="22" ry="14" fill="none" stroke="#FF6B9D" stroke-width="2.5" stroke-linecap="round" style="filter: url(#crayon-texture);"/>
				<line x1="11" y1="9" x2="18" y2="15" stroke="#FFD700" stroke-width="2.5" stroke-linecap="round" style="filter: url(#crayon-texture);"/>
				<line x1="15" y1="7" x2="22" y2="13" stroke="#FFD700" stroke-width="2.5" stroke-linecap="round" style="filter: url(#crayon-texture);"/>
				<line x1="19" y1="5" x2="26" y2="11" stroke="#FFD700" stroke-width="2.5" stroke-linecap="round" style="filter: url(#crayon-texture);"/>
			</svg>

			<!-- Squares -->
			<svg style="position: absolute; bottom: 18%; right: 25%; width: 27px; height: 27px; animation: floatSlow1 7s ease-in-out infinite;">
				<rect x="3" y="3" width="21" height="21" fill="none" stroke="#FFD700" stroke-width="2.5" transform="rotate(20 13.5 13.5)" style="filter: url(#crayon-texture);"/>
			</svg>
			<svg class="hidden md:block" style="position: absolute; top: 32%; left: 8%; width: 24px; height: 24px; animation: slowRotate 20s linear infinite;">
				<rect x="3" y="3" width="18" height="18" fill="none" stroke="#6FA8DC" stroke-width="2.5" transform="rotate(15 12 12)" style="filter: url(#crayon-texture);"/>
			</svg>
			<svg class="hidden md:block" style="position: absolute; top: 15%; left: 35%; width: 22px; height: 22px; animation: floatSlow2 8s ease-in-out infinite;">
				<rect x="3" y="3" width="16" height="16" fill="#FF6B9D" stroke="#FF6B9D" stroke-width="2" transform="rotate(25 11 11)" style="filter: url(#crayon-texture);"/>
			</svg>

			<!-- Small circles -->
			<svg class="hidden md:block" style="position: absolute; top: 25%; right: 28%; width: 16px; height: 16px; animation: floatGentle 7s ease-in-out infinite;">
				<circle cx="8" cy="8" r="6" fill="#FFD700"/>
			</svg>
			<svg class="hidden md:block" style="position: absolute; top: 22%; left: 20%; width: 14px; height: 14px; animation: floatSlow1 9s ease-in-out infinite;">
				<circle cx="7" cy="7" r="5" fill="#6FA8DC"/>
			</svg>
		</div>

		<!-- Cover Screen -->
		<div id="cover-screen" class="fixed inset-0 flex items-center justify-center z-50 transition-opacity duration-700" style="overflow: hidden;">
			<!-- Flying rocket decoration -->
			<div style="position: absolute; inset: 0; pointer-events: none;">
				<!-- Blue Rocket - Desktop (left to right) -->
				<svg class="hidden md:block" style="position: absolute; left: -60px; top: 15%; width: 50px; height: 60px; animation: rocketFlyDesktop 7s ease-out 0.5s forwards; transform: scaleX(-1);">
					<path d="M25,10 L30,35 L20,35 Z" fill="#6FA8DC" stroke="#6FA8DC" stroke-width="2" style="filter: url(#crayon-texture);"/>
					<rect x="20" y="32" width="10" height="15" fill="#6FA8DC" stroke="#6FA8DC" stroke-width="2" style="filter: url(#crayon-texture);"/>
					<path d="M18,45 L15,52 L20,47 Z" fill="#FF6B9D" stroke="#FF6B9D" stroke-width="1.5" style="filter: url(#crayon-texture);"/>
					<path d="M32,45 L35,52 L30,47 Z" fill="#FF6B9D" stroke="#FF6B9D" stroke-width="1.5" style="filter: url(#crayon-texture);"/>
					<circle cx="25" cy="25" r="3" fill="#FFF"/>
				</svg>

				<!-- Blue Rocket - Mobile (bottom to top) -->
				<svg class="block md:hidden" style="position: absolute; bottom: -60px; left: 50%; transform: translateX(-50%); width: 50px; height: 60px; animation: rocketFlyMobile 5s ease-out 0.5s forwards;">
					<path d="M25,10 L30,35 L20,35 Z" fill="#6FA8DC" stroke="#6FA8DC" stroke-width="2" style="filter: url(#crayon-texture);"/>
					<rect x="20" y="32" width="10" height="15" fill="#6FA8DC" stroke="#6FA8DC" stroke-width="2" style="filter: url(#crayon-texture);"/>
					<path d="M18,45 L15,52 L20,47 Z" fill="#FF6B9D" stroke="#FF6B9D" stroke-width="1.5" style="filter: url(#crayon-texture);"/>
					<path d="M32,45 L35,52 L30,47 Z" fill="#FF6B9D" stroke="#FF6B9D" stroke-width="1.5" style="filter: url(#crayon-texture);"/>
					<circle cx="25" cy="25" r="3" fill="#FFF"/>
				</svg>
			</div>

			<div class="text-center px-6 md:px-8 relative z-10">
				<h1 class="text-3xl md:text-5xl lg:text-6xl mb-3 md:mb-4" style="font-family: 'Ongeullip Cocoa'; font-weight: 700; color: #6FA8DC; line-height: 1.3;">
					ë‚˜ì—ê²Œ ë”±! ë§ëŠ”<br>BEE ê²¨ìš¸ íŠ¹ê°• ê³¼ëª©ì€?
				</h1>
				<p class="text-lg md:text-xl lg:text-2xl mb-8 md:mb-10" style="font-family: 'Ongeullip Cocoa'; font-weight: 700; color: #6FA8DC;">ë‹¹ì‹ ì„ ìœ„í•œ ë§ì¶¤ ê³¼ëª© ì°¾ê¸°</p>
				<button
					id="start-btn"
					class="px-8 py-3 md:px-12 md:py-4 rounded-full text-white text-lg md:text-xl shadow-2xl hover:shadow-3xl hover:scale-110 transition-all duration-300"
					style="background: linear-gradient(135deg, #6FA8DC 0%, #5B9BD5 100%); font-family: 'Ongeullip Cocoa'; font-weight: 700; filter: url(#crayon-texture);"
				>
					ì‹œì‘í•˜ê¸°
				</button>
			</div>
		</div>

		<!-- Restart Widget (shown only on result screen) -->
		<div id="restart-widget" class="fixed bottom-16 md:bottom-24 left-1/2 transform -translate-x-1/2 hidden z-50 opacity-0 transition-opacity duration-500">
			<button
				id="restart-btn"
				class="px-6 py-3 md:px-8 md:py-4 rounded-full text-white text-base md:text-lg shadow-2xl hover:shadow-3xl hover:scale-105 transition-all duration-300"
				style="background: linear-gradient(135deg, #6FA8DC 0%, #5B9BD5 100%); font-family: 'Ongeullip Cocoa'; font-weight: 700; filter: url(#crayon-texture);"
			>
				ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì„ íƒí•˜ê¸°
			</button>
		</div>

		<!-- Flowchart Container -->
		<div class="relative w-full" style="min-height: 1000px; overflow: visible;">
			<!-- SVG for arrows with pencil texture -->
			<svg id="arrows-svg" class="absolute inset-0 w-full h-full pointer-events-none" style="z-index: 3; transform-origin: 0 0; transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1); overflow: visible;">
				<defs>
					<!-- Crayon/Pencil texture filter for green (YES) -->
					<filter id="pencil-green">
						<feTurbulence type="fractalNoise" baseFrequency="1.2" numOctaves="5" result="noise" seed="2" />
						<feDisplacementMap in="SourceGraphic" in2="noise" scale="3" xChannelSelector="R" yChannelSelector="G" />
						<feGaussianBlur stdDeviation="0.5" />
					</filter>
					<!-- Crayon/Pencil texture filter for pink (NO) -->
					<filter id="pencil-pink">
						<feTurbulence type="fractalNoise" baseFrequency="1.2" numOctaves="5" result="noise" seed="5" />
						<feDisplacementMap in="SourceGraphic" in2="noise" scale="3" xChannelSelector="R" yChannelSelector="G" />
						<feGaussianBlur stdDeviation="0.5" />
					</filter>
					<!-- Crayon texture for nodes and buttons -->
					<filter id="crayon-texture">
						<feTurbulence type="fractalNoise" baseFrequency="3" numOctaves="4" result="noise" seed="10" />
						<feDisplacementMap in="SourceGraphic" in2="noise" scale="5" xChannelSelector="R" yChannelSelector="G" />
						<feGaussianBlur stdDeviation="0.2" />
					</filter>
					<!-- Stronger crayon texture for circular nodes -->
					<filter id="crayon-circle">
						<feTurbulence type="fractalNoise" baseFrequency="3.5" numOctaves="6" result="noise" seed="15" />
						<feDisplacementMap in="SourceGraphic" in2="noise" scale="8" xChannelSelector="R" yChannelSelector="G" />
						<feGaussianBlur stdDeviation="0.8" />
					</filter>
					<!-- Crayon texture for text -->
					<filter id="crayon-text">
						<feTurbulence type="fractalNoise" baseFrequency="4" numOctaves="3" result="noise" seed="20" />
						<feDisplacementMap in="SourceGraphic" in2="noise" scale="2" xChannelSelector="R" yChannelSelector="G" />
						<feGaussianBlur stdDeviation="0.2" />
					</filter>
					<!-- Subtle crayon texture for background -->
					<filter id="crayon-bg">
						<feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" result="noise" seed="5" />
						<feColorMatrix in="noise" type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.15 0" result="opacity-noise"/>
						<feBlend in="SourceGraphic" in2="opacity-noise" mode="multiply"/>
					</filter>
				</defs>
			</svg>

			<!-- Flowchart nodes -->
			<div id="flowchart" class="relative w-full h-full" style="z-index: 2; transform-origin: 0 0; transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);">
				<!-- Nodes will be positioned absolutely -->
			</div>
		</div>

	</div>

	<style>
		/* Apply background color */
		#loading-screen,
		#main-content,
		#cover-screen {
			background: #FBF5E8;
		}

		/* Apply subtle crayon texture on mobile only for main content */
		@media (max-width: 767px) {
			#main-content {
				position: relative;
				background: transparent;
			}

			#main-content::before {
				content: '';
				position: absolute;
				inset: 0;
				background: #FBF5E8;
				filter: url(#crayon-texture);
				z-index: -1;
			}

			/* YES/NO ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ì •ë ¬ ê°•ì œ (ëª¨ë°”ì¼ ì „ìš©) */
			.absolute.left-1\/2.transform.-translate-x-1\/2 {
				left: 50% !important;
				transform: translateX(-50%) !important;
			}
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Decorative animations */
		@keyframes floatGentle {
			0%, 100% {
				transform: translateY(0);
			}
			50% {
				transform: translateY(-10px);
			}
		}

		@keyframes floatSlow1 {
			0%, 100% {
				transform: translate(0, 0);
			}
			50% {
				transform: translate(-8px, -12px);
			}
		}

		@keyframes floatSlow2 {
			0%, 100% {
				transform: translate(0, 0);
			}
			50% {
				transform: translate(10px, -15px);
			}
		}

		@keyframes slowRotate {
			from {
				transform: rotate(0deg);
			}
			to {
				transform: rotate(360deg);
			}
		}

		@keyframes gentleSpin {
			from {
				transform: rotate(0deg);
			}
			to {
				transform: rotate(360deg);
			}
		}

		/* Rocket flying animations */
		@keyframes rocketFlyDesktop {
			0% {
				transform: scaleX(-1) translateX(0) translateY(0) rotate(-90deg);
				opacity: 0;
			}
			15% {
				opacity: 1;
			}
			85% {
				opacity: 1;
			}
			100% {
				transform: scaleX(-1) translateX(-110vw) translateY(-30px) rotate(-85deg);
				opacity: 0;
			}
		}

		@keyframes rocketFlyMobile {
			0% {
				transform: translateX(-50%) translateY(0) rotate(0deg);
				opacity: 0;
			}
			15% {
				opacity: 1;
			}
			85% {
				opacity: 1;
			}
			100% {
				transform: translateX(-50%) translateY(-110vh) rotate(-5deg);
				opacity: 0;
			}
		}

		/* Touch feedback for buttons */
		button {
			position: relative;
			overflow: hidden;
			transition: all 0.15s ease;
			-webkit-tap-highlight-color: transparent;
		}

		button:active {
			transform: scale(0.95) !important;
			filter: brightness(0.9);
		}

		/* Ripple effect */
		button::after {
			content: '';
			position: absolute;
			top: 50%;
			left: 50%;
			width: 0;
			height: 0;
			border-radius: 50%;
			background: rgba(255, 255, 255, 0.5);
			transform: translate(-50%, -50%);
			transition: width 0.6s, height 0.6s;
		}

		button:active::after {
			width: 300px;
			height: 300px;
			transition: 0s;
		}

		/* Back button hover effect */
		.back-btn {
			transition: all 0.2s ease;
		}

		.back-btn:hover {
			filter: url(#crayon-texture) !important;
		}
	</style>

	<script>
		// Loading screen animation
		const loadingScreen = document.getElementById('loading-screen');
		const mainContent = document.getElementById('main-content');

		// Hide loading screen and show content after animation
		window.addEventListener('load', () => {
			setTimeout(() => {
				if (loadingScreen) {
					loadingScreen.style.opacity = '0';
					setTimeout(() => {
						loadingScreen.style.display = 'none';
					}, 700);
				}
				if (mainContent) {
					mainContent.style.opacity = '1';
					mainContent.style.transition = 'opacity 0.7s ease-out';
				}
			}, 1500); // Show loading for 1.5 seconds
		});

		// Flow data structure with positions
		const flowData: Record<number, any> = {
			1: {
				text: "ë‚˜ëŠ” ì˜¨ë¼ì¸(ZOOM)\nìˆ˜ì—…ì„ ì„ í˜¸í•œë‹¤",
				yes: 2,
				no: 3,
				x: 200,
				y: 450,
				isQuestion: true
			},
			2: {
				text: "ë‚˜ëŠ” ê°ˆë¼ë””ì•„ì„œ/ë¡œë§ˆì„œë¥¼\nëª¨ë‘ ìˆ˜ê°•í–ˆë‹¤",
				textDesktop: "ë‚˜ëŠ” ê°ˆë¼ë””ì•„ì„œ/\në¡œë§ˆì„œë¥¼ ëª¨ë‘ ìˆ˜ê°•í–ˆë‹¤",
				yes: 14,
				no: 13,
				x: 500,
				y: 300,
				isQuestion: true
			},
			3: {
				text: "ë‚˜ëŠ” ê°ˆë¼ë””ì•„ì„œë¥¼\nì´ë¯¸ ìˆ˜ê°•í–ˆë‹¤",
				yes: 10,
				no: 7,
				x: 500,
				y: 600,
				isQuestion: true
			},
			4: {
				book: "ê³ ë¦°ë„ì „ì„œ",
				time: "1/4-3/1",
				image: "/playground/corinthians-char.png",
				isResult: true,
				x: 1100,
				y: 100
			},
			6: {
				book: "íˆë¸Œë¦¬ì„œ",
				time: "ì„ êµê´€202, 12/30-2/24",
				image: "/playground/hebrews-char.png",
				isResult: true,
				x: 1100,
				y: 530
			},
			7: {
				text: "ì˜¬ ê²¨ìš¸ì—”\nì‹ ì•½ ì „ì²´ë¥¼\nì½ì–´ë³´ê³  ì‹¶ë‹¤",
				yes: 9,
				no: 8,
				x: 800,
				y: 700,
				isQuestion: true
			},
			8: {
				book: "í•˜ë‚˜ë‹˜ì˜ ì„±í’ˆ",
				time: "ì„ êµê´€202, 1/8-2/26",
				image: "/playground/god-char.png",
				isResult: true,
				x: 1100,
				y: 650
			},
			9: {
				book: "ì„±ê²½ì„ í¼ì³ë¼(ì‹ ì•½)",
				time: "ì•„ë¡ í™€, 1/3-2/21",
				image: "/playground/bible-char.png",
				isResult: true,
				x: 1100,
				y: 800
			},
			10: {
				text: "ë‚˜ëŠ” ë¡œë§ˆì„œë„ ìˆ˜ê°•ì™„ë£Œí•´ì„œ\nìƒˆë¡œìš´ ê³¼ëª©ì„\nê³µë¶€í•´ë³´ê³  ì‹¶ë‹¤",
				textDesktop: "ë¡œë§ˆì„œë„\nìˆ˜ê°•ì™„ë£Œí•´ì„œ\nìƒˆë¡œìš´ ê³¼ëª©ì„\nê³µë¶€í•´ë³´ê³  ì‹¶ë‹¤",
				yes: 6,
				no: 11,
				x: 800,
				y: 550,
				isQuestion: true
			},
			11: {
				book: "ë¡œë§ˆì„œ",
				time: "B102, 1/8-2/26",
				image: "/playground/romans-char.png",
				isResult: true,
				x: 1100,
				y: 450
			},
			13: {
				book: "ê°ˆë¼ë””ì•„ì„œ",
				time: "â‘  ì¼ ì˜¤í›„ 12/28-2/22\nâ‘¡ ì›” ì˜¤ì „ 12/29-2/23",
				image: "/playground/galatians-char.png",
				isResult: true,
				largeCard: true,
				x: 1100,
				y: 250
			},
			14: {
				text: "ë‚´ê°€ ì¢‹ì•„í•˜ëŠ” ì‚¬ë„ëŠ”? ğŸ’Œ",
				textDesktop: "ë‚´ê°€ ì¢‹ì•„í•˜ëŠ”\nì‚¬ë„ëŠ”? ğŸ’Œ",
				yes: 4,
				no: 15,
				yesLabel: "ë°”ìš¸",
				noLabel: "ìš”í•œ",
				x: 800,
				y: 150,
				isQuestion: true
			},
			15: {
				book: "ìš”í•œë³µìŒ",
				time: "1/2-2/20",
				image: "/playground/john-char.png",
				isResult: true,
				x: 1100,
				y: 120
			}
		};

		const connections = [
			{ from: 1, to: 2, type: 'yes' },
			{ from: 1, to: 3, type: 'no' },
			{ from: 2, to: 14, type: 'yes' },
			{ from: 2, to: 13, type: 'no' },
			{ from: 14, to: 4, type: 'yes' },
			{ from: 14, to: 15, type: 'no' },
			{ from: 3, to: 10, type: 'yes' },
			{ from: 3, to: 7, type: 'no' },
			{ from: 10, to: 6, type: 'yes' },
			{ from: 10, to: 11, type: 'no' },
			{ from: 7, to: 9, type: 'yes' },
			{ from: 7, to: 8, type: 'no' }
		];

		const flowchart = document.getElementById('flowchart');
		const arrowsSvg = document.getElementById('arrows-svg');
		const coverScreen = document.getElementById('cover-screen');
		const startBtn = document.getElementById('start-btn');
		const restartWidget = document.getElementById('restart-widget');
		const restartBtn = document.getElementById('restart-btn');
		let selectedPath: number[] = [];
		let createdNodes = new Set<number>();
		let hasStarted = false;

		// Prezi-like zoom and pan to node
		function zoomToNode(nodeId: number) {
			const data = flowData[nodeId];
			const containerWidth = window.innerWidth;
			const containerHeight = window.innerHeight;

			// Calculate scale (zoom level) - smaller on mobile
			const isMobile = containerWidth < 768;
			const scale = isMobile ? 1.2 : 1.5;

			// For first node on desktop, position slightly to the left
			let targetX, targetY;
			if (nodeId === 1 && !isMobile) {
				targetX = containerWidth * 0.35; // 35% from left on desktop
				targetY = containerHeight / 2;
			} else {
				targetX = containerWidth / 2;
				targetY = containerHeight / 2;
			}

			// Calculate translation
			const translateX = targetX - (data.x * scale);
			const translateY = targetY - (data.y * scale);

			// Apply transform to flowchart and SVG
			if (flowchart) {
				flowchart.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
			}
			if (arrowsSvg) {
				arrowsSvg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
			}
		}

		// Zoom to show entire path (for result nodes)
		function zoomToPath(path: number[]) {
			if (path.length === 0) return;

			const containerWidth = window.innerWidth;
			const containerHeight = window.innerHeight;

			// Find bounding box of all nodes in the path
			let minX = Infinity, maxX = -Infinity;
			let minY = Infinity, maxY = -Infinity;

			path.forEach(nodeId => {
				const node = flowData[nodeId];
				if (node) {
					minX = Math.min(minX, node.x);
					maxX = Math.max(maxX, node.x);
					minY = Math.min(minY, node.y);
					maxY = Math.max(maxY, node.y);
				}
			});

			// Add padding
			const padding = 250;
			minX -= padding;
			maxX += padding;
			minY -= padding;
			maxY += padding;

			// Calculate scale to fit all nodes
			const pathWidth = maxX - minX;
			const pathHeight = maxY - minY;
			const scaleX = containerWidth / pathWidth;
			const scaleY = containerHeight / pathHeight;
			const scale = Math.min(scaleX, scaleY, 0.9); // Cap at 0.9x

			// Position result node (last node) to the right side (80% of screen width)
			const resultNode = flowData[path[path.length - 1]];
			const targetX = containerWidth * 0.75; // Result node at 75% from left (= right side)
			const translateX = targetX - (resultNode.x * scale);

			// Center vertically
			const centerY = (minY + maxY) / 2;
			const translateY = (containerHeight / 2) - (centerY * scale);

			// Apply transform
			if (flowchart) {
				flowchart.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
			}
			if (arrowsSvg) {
				arrowsSvg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
			}
		}

		function drawArrow(x1: number, y1: number, x2: number, y2: number, type: string, highlighted: boolean, fromNodeId?: number) {
			const color = type === 'yes' ? '#42A5F5' : '#F06292';
			const filter = type === 'yes' ? 'url(#pencil-green)' : 'url(#pencil-pink)';

			// Adjust start and end points to account for node size
			const nodeRadius = 80;

			const dx = x2 - x1;
			const dy = y2 - y1;
			const angle = Math.atan2(dy, dx);

			// Start point from circular node edge
			const startX = x1 + nodeRadius * Math.cos(angle);
			const startY = y1 + nodeRadius * Math.sin(angle);

			// Find the target node to check if it's a result
			const targetNode = Object.values(flowData).find(node => node.x === x2 && node.y === y2);
			const isTargetResult = targetNode?.isResult || false;

			// End point - stop at the edge of the target node
			let endX, endY;
			if (isTargetResult) {
				// For result boxes, calculate distance based on box size
				// Mobile: 160x160, Desktop: 180x180
				const isMobile = window.innerWidth < 768;
				const boxHalfWidth = isMobile ? 80 : 90;
				const boxHalfHeight = isMobile ? 80 : 90;

				// Calculate which edge the arrow hits based on angle
				const absAngle = Math.abs(angle);
				const threshold = Math.atan2(boxHalfHeight, boxHalfWidth);

				if (absAngle < threshold || absAngle > Math.PI - threshold) {
					// Hits left/right edge
					endX = x2 - Math.sign(Math.cos(angle)) * boxHalfWidth;
					endY = y2 - boxHalfWidth * Math.tan(angle) * Math.sign(Math.cos(angle));
				} else {
					// Hits top/bottom edge
					endX = x2 - boxHalfHeight / Math.tan(angle) * Math.sign(Math.sin(angle));
					endY = y2 - Math.sign(Math.sin(angle)) * boxHalfHeight;
				}
			} else {
				// For circular nodes, stop at the circle edge
				endX = x2 - nodeRadius * Math.cos(angle);
				endY = y2 - nodeRadius * Math.sin(angle);
			}

			// Create curved path
			const controlX = startX + (endX - startX) * 0.5;
			const controlY = startY + (endY - startY) * 0.5;

			const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
			const d = `M ${startX} ${startY} Q ${controlX} ${controlY}, ${endX} ${endY}`;
			path.setAttribute('d', d);
			path.setAttribute('stroke', color);
			const strokeWidth = highlighted ? '5' : '3';
			path.setAttribute('stroke-width', strokeWidth);
			path.setAttribute('fill', 'none');
			path.setAttribute('stroke-linecap', 'round');
			path.setAttribute('filter', filter);
			path.setAttribute('opacity', '1');
			path.setAttribute('class', 'arrow-path');

			// Create arrowhead
			const arrowHead = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
			const arrowSize = 14;
			const arrowAngle = Math.atan2(endY - controlY, endX - controlX);
			const point1X = endX;
			const point1Y = endY;
			const point2X = endX - arrowSize * Math.cos(arrowAngle - Math.PI / 6);
			const point2Y = endY - arrowSize * Math.sin(arrowAngle - Math.PI / 6);
			const point3X = endX - arrowSize * Math.cos(arrowAngle + Math.PI / 6);
			const point3Y = endY - arrowSize * Math.sin(arrowAngle + Math.PI / 6);

			arrowHead.setAttribute('points', `${point1X},${point1Y} ${point2X},${point2Y} ${point3X},${point3Y}`);
			arrowHead.setAttribute('fill', color);
			arrowHead.setAttribute('filter', filter);
			arrowHead.setAttribute('opacity', '1');
			arrowHead.setAttribute('class', 'arrow-head');

			arrowsSvg?.appendChild(path);
			arrowsSvg?.appendChild(arrowHead);
		}

		// Create a single node
		function createNode(id: number) {
			if (createdNodes.has(id)) return;
			createdNodes.add(id);

			const data = flowData[id];
			const node = document.createElement('div');
			node.id = `node-${id}`;
			node.className = 'absolute';
			node.style.left = `${data.x}px`;
			node.style.top = `${data.y}px`;
			node.style.transform = 'translate(-50%, -50%)';
			node.style.opacity = '0';
			node.style.transition = 'opacity 0.5s ease-out';

			if (data.isResult) {
				// Result node
				const isMobile = window.innerWidth < 768;
				const cardWidth = data.largeCard ? (isMobile ? '200px' : '200px') : (isMobile ? '180px' : '180px');
				const cardHeight = data.largeCard ? (isMobile ? '220px' : '220px') : (isMobile ? '185px' : '185px');
				node.innerHTML = `
					<div class="relative" style="width: ${cardWidth}; height: ${cardHeight};">
						<!-- Background box with crayon effect and doodles -->
						<div class="bg-white rounded-xl shadow-lg border-4 absolute inset-0" style="border-color: #F8BBD0; filter: url(#crayon-texture); padding: ${isMobile ? '1rem' : '1rem'}; overflow: hidden;">
							<!-- Doodle pattern -->
							<svg style="position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0.15; pointer-events: none;">
								<!-- Stars -->
								<path d="M30,20 L32,26 L38,26 L33,30 L35,36 L30,32 L25,36 L27,30 L22,26 L28,26 Z" fill="none" stroke="#FFD700" stroke-width="1.5"/>
								<path d="M250,40 L252,45 L257,45 L253,48 L255,53 L250,49 L245,53 L247,48 L243,45 L248,45 Z" fill="none" stroke="#6FA8DC" stroke-width="1.5"/>

								<!-- Hearts -->
								<path d="M80,25 Q75,20 70,25 Q65,20 60,25 Q60,32 70,40 Q80,32 80,25 Z" fill="none" stroke="#FF6B9D" stroke-width="1.5"/>
								<path d="M200,80 Q195,75 190,80 Q185,75 180,80 Q180,87 190,95 Q200,87 200,80 Z" fill="none" stroke="#FFD700" stroke-width="1.5"/>

								<!-- Circles -->
								<circle cx="100" cy="70" r="8" fill="none" stroke="#6FA8DC" stroke-width="1.5"/>
								<circle cx="270" cy="25" r="6" fill="none" stroke="#FF6B9D" stroke-width="1.5"/>
								<circle cx="50" cy="90" r="5" fill="none" stroke="#FFD700" stroke-width="1.5"/>

								<!-- Small dots -->
								<circle cx="150" cy="30" r="2" fill="#6FA8DC"/>
								<circle cx="120" cy="95" r="2" fill="#FF6B9D"/>
								<circle cx="230" cy="65" r="2" fill="#FFD700"/>
								<circle cx="180" cy="35" r="2" fill="#6FA8DC"/>

								<!-- Zigzag lines -->
								<path d="M40,60 L45,55 L50,60 L55,55" fill="none" stroke="#6FA8DC" stroke-width="1.5"/>
								<path d="M220,100 L225,95 L230,100 L235,95" fill="none" stroke="#FF6B9D" stroke-width="1.5"/>
							</svg>
						</div>
						<!-- Text layer on top without filter -->
						<div class="absolute inset-0 flex flex-col justify-between" style="padding: ${isMobile ? '0.75rem' : '1rem'};">
							<div class="flex-1 flex flex-col items-center justify-center">
								${data.image ? `
								<div class="mb-2">
									<img src="${data.image}" alt="${data.book}"
										style="width: ${isMobile ? '3rem' : '3.5rem'}; height: ${isMobile ? '3rem' : '3.5rem'}; border-radius: 50%; object-fit: cover; border: 2px solid #D4C5B9;">
								</div>
								` : ''}
								<div class="text-center mb-1">
									<a href="https://www.beekorea.org/lms/seminar/" target="_blank" rel="noopener noreferrer" class="font-bold" style="font-family: 'Ongeullip Cocoa'; color: #6B5B4F; font-size: ${isMobile ? '0.95rem' : '1.1rem'}; cursor: pointer; text-decoration: none;">${data.book}</a>
								</div>
								<div class="text-center">
									<p style="font-family: 'Ongeullip Cocoa'; font-weight: 700; color: #8B7355; font-size: ${isMobile ? '0.75rem' : '0.85rem'}; white-space: pre-line;">${data.time}</p>
								</div>
							</div>
							<!-- Action buttons at bottom -->
							<div class="flex gap-2 justify-center" style="margin-top: 0.5rem; align-items: stretch;">
								<a href="https://www.beekorea.org/lms/accounts/signup/" target="_blank" rel="noopener noreferrer"
									class="relative rounded-lg font-bold hover:scale-105 transition-all duration-200"
									style="font-family: 'Ongeullip Cocoa'; padding: ${isMobile ? '0.5rem 0.5rem' : '0.5rem 0.75rem'}; font-size: ${isMobile ? '0.7rem' : '0.75rem'}; display: flex; align-items: center; justify-content: center; min-height: ${isMobile ? '2rem' : 'auto'}; width: calc(50% - 0.25rem); min-width: 70px;">
									<span class="absolute inset-0 rounded-lg" style="background: linear-gradient(135deg, #6FA8DC 0%, #5B9BD5 100%); filter: url(#crayon-texture);"></span>
									<span class="relative text-white text-center" style="text-shadow: 0 1px 2px rgba(0,0,0,0.3);">íšŒì›ê°€ì…</span>
								</a>
								<a href="https://www.beekorea.org/lms/seminar/" target="_blank" rel="noopener noreferrer"
									class="relative rounded-lg font-bold hover:scale-105 transition-all duration-200"
									style="font-family: 'Ongeullip Cocoa'; padding: ${isMobile ? '0.5rem 0.5rem' : '0.5rem 0.75rem'}; font-size: ${isMobile ? '0.7rem' : '0.75rem'}; display: flex; align-items: center; justify-content: center; min-height: ${isMobile ? '2rem' : 'auto'}; width: calc(50% - 0.25rem); min-width: 70px;">
									<span class="absolute inset-0 rounded-lg" style="background: linear-gradient(135deg, #FF6B9D 0%, #E85A8B 100%); filter: url(#crayon-texture);"></span>
									<span class="relative text-white text-center" style="text-shadow: 0 1px 2px rgba(0,0,0,0.3);">ìˆ˜ê°•ì‹ ì²­</span>
								</a>
							</div>
						</div>
					</div>
				`;
			} else {
				// Question node (circular)
				const isMobile = window.innerWidth < 768;
				const nodeSize = isMobile ? '9rem' : '10rem'; // 144px vs 160px
				const textSize = isMobile ? '0.8rem' : '0.875rem';
				const buttonWidth = '80px'; // PC í¬ê¸°ë¡œ í†µì¼
				const buttonHeight = '42px'; // PC í¬ê¸°ë¡œ í†µì¼
				const buttonFontSize = isMobile ? '0.85rem' : '0.9rem'; // í°íŠ¸ í¬ê¸° í†µì¼

				const showBackButton = selectedPath.length > 1; // Show back button if not first node
				const yesLabel = data.yesLabel || 'YES';
				const noLabel = data.noLabel || 'NO';
				const displayText = (!isMobile && data.textDesktop) ? data.textDesktop : data.text;

				node.innerHTML = `
					<div class="relative">
						<!-- Background circle with crayon effect -->
						<div class="rounded-full bg-white shadow-lg border-4 absolute" style="width: ${nodeSize}; height: ${nodeSize}; border-color: #FFD54F; filter: url(#crayon-circle);"></div>
						<!-- Text layer on top without filter -->
						<div class="rounded-full flex items-center justify-center relative" style="width: ${nodeSize}; height: ${nodeSize}; padding: ${isMobile ? '0.75rem' : '1rem'};">
							<h3 class="text-center whitespace-pre-line leading-tight" style="font-family: 'Ongeullip Cocoa'; font-weight: 700; color: #5D4E37; font-size: ${textSize};">${displayText}</h3>
						</div>
						<div class="absolute left-1/2 transform -translate-x-1/2 flex gap-2" style="bottom: -4rem; z-index: 100; align-items: center; justify-content: center; display: flex;">
							<button
								class="yes-btn rounded-lg font-bold hover:scale-105 transition-all duration-200 shadow-md"
								style="position: relative; pointer-events: auto; cursor: pointer; z-index: 100; width: ${buttonWidth}; height: ${buttonHeight}; padding: 0; display: flex; align-items: center; justify-content: center; box-sizing: border-box; flex-shrink: 0;"
								data-node="${id}"
								data-next="${data.yes}"
							>
								<span class="rounded-lg" style="position: absolute; inset: 0; background: linear-gradient(135deg, #6FA8DC 0%, #5B9BD5 100%); filter: url(#crayon-texture); z-index: 1;"></span>
								<span style="position: relative; z-index: 2; font-family: 'Ongeullip Cocoa'; font-weight: 900; color: white; font-size: ${buttonFontSize}; pointer-events: none; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${yesLabel}</span>
							</button>
							<button
								class="no-btn rounded-lg font-bold hover:scale-105 transition-all duration-200 shadow-md"
								style="position: relative; pointer-events: auto; cursor: pointer; z-index: 100; width: ${buttonWidth}; height: ${buttonHeight}; padding: 0; display: flex; align-items: center; justify-content: center; box-sizing: border-box; flex-shrink: 0;"
								data-node="${id}"
								data-next="${data.no}"
							>
								<span class="rounded-lg" style="position: absolute; inset: 0; background: linear-gradient(135deg, #FF6B9D 0%, #E85A8B 100%); filter: url(#crayon-texture); z-index: 1;"></span>
								<span style="position: relative; z-index: 2; font-family: 'Ongeullip Cocoa'; font-weight: 900; color: white; font-size: ${buttonFontSize}; pointer-events: none; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${noLabel}</span>
							</button>
						</div>
						${showBackButton ? `
						<div class="absolute left-1/2 transform -translate-x-1/2" style="bottom: ${isMobile ? '-8rem' : '-9rem'}; z-index: 100;">
							<button
								class="back-btn rounded-full hover:scale-110 shadow-md"
								style="background: #D0D0D0; font-family: 'Ongeullip Cocoa'; font-weight: 900; color: white; pointer-events: auto; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; width: ${isMobile ? '36px' : '40px'}; height: ${isMobile ? '36px' : '40px'}; font-size: ${isMobile ? '1.2rem' : '1.4rem'}; transition: all 0.2s ease; line-height: 0; filter: url(#crayon-texture);"
								data-node="${id}"
							>
								<span style="pointer-events: none; display: block; margin-top: 3px;">â†</span>
							</button>
						</div>
						` : ''}
					</div>
				`;
			}

			flowchart?.appendChild(node);

			// Zoom to this node (Prezi effect)
			if (data.isResult) {
				// For result nodes, position on the right side
				const containerWidth = window.innerWidth;
				const containerHeight = window.innerHeight;
				const isMobile = containerWidth < 768;
				const scale = isMobile ? 1.2 : 1.5;
				// Responsive positioning: 45% on mobile, 65% on desktop
				const targetPercentage = isMobile ? 0.45 : 0.65;
				const targetX = containerWidth * targetPercentage;
				const translateX = targetX - (data.x * scale);
				const translateY = (containerHeight / 2) - (data.y * scale);

				if (flowchart) {
					flowchart.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
				}
				if (arrowsSvg) {
					arrowsSvg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
				}
			} else {
				zoomToNode(id);
			}

			// Fade in animation
			setTimeout(() => {
				node.style.opacity = '1';
			}, 100);

			// Show restart widget if result node
			if (data.isResult) {
				setTimeout(() => {
					if (restartWidget) {
						restartWidget.classList.remove('hidden');
						setTimeout(() => {
							restartWidget.style.opacity = '1';
						}, 100);
					}
				}, 500);
			}

			// Attach button listeners for this specific node
			if (!data.isResult) {
				// Immediately attach listeners (no delay)
				const yesBtn = node.querySelector('.yes-btn') as HTMLButtonElement;
				const noBtn = node.querySelector('.no-btn') as HTMLButtonElement;
				const backBtn = node.querySelector('.back-btn') as HTMLButtonElement;

				if (yesBtn && !yesBtn.hasAttribute('data-listener-attached')) {
					yesBtn.setAttribute('data-listener-attached', 'true');
					yesBtn.addEventListener('click', (e) => {
						e.preventDefault();
						e.stopPropagation();
						const nodeId = parseInt(yesBtn.getAttribute('data-node') || '0');
						const nextId = parseInt(yesBtn.getAttribute('data-next') || '0');
						handleChoice(nodeId, nextId, 'yes');
					}, { once: false });
				}

				if (noBtn && !noBtn.hasAttribute('data-listener-attached')) {
					noBtn.setAttribute('data-listener-attached', 'true');
					noBtn.addEventListener('click', (e) => {
						e.preventDefault();
						e.stopPropagation();
						const nodeId = parseInt(noBtn.getAttribute('data-node') || '0');
						const nextId = parseInt(noBtn.getAttribute('data-next') || '0');
						handleChoice(nodeId, nextId, 'no');
					}, { once: false });
				}

				if (backBtn && !backBtn.hasAttribute('data-listener-attached')) {
					backBtn.setAttribute('data-listener-attached', 'true');
					backBtn.addEventListener('click', (e) => {
						e.preventDefault();
						e.stopPropagation();
						handleGoBack();
					}, { once: false });

					// Add hover effect for crayon texture
					backBtn.addEventListener('mouseenter', () => {
						backBtn.style.filter = 'url(#crayon-texture)';
					});
					backBtn.addEventListener('mouseleave', () => {
						backBtn.style.filter = 'none';
					});
				}
			}
		}

		// Handle go back
		function handleGoBack() {
			if (selectedPath.length <= 1) return; // Can't go back from first node

			// Remove current node
			const currentNodeId = selectedPath[selectedPath.length - 1];
			const currentNodeElement = document.getElementById(`node-${currentNodeId}`);
			if (currentNodeElement) {
				currentNodeElement.remove();
			}
			createdNodes.delete(currentNodeId);
			selectedPath.pop();

			// Remove previous node to recreate it with buttons
			const previousNodeId = selectedPath[selectedPath.length - 1];
			const previousNodeElement = document.getElementById(`node-${previousNodeId}`);
			if (previousNodeElement) {
				previousNodeElement.remove();
			}
			createdNodes.delete(previousNodeId);

			// Clear all arrows and redraw path
			if (arrowsSvg) {
				const arrows = arrowsSvg.querySelectorAll('.arrow-path, .arrow-head');
				arrows.forEach(arrow => arrow.remove());
			}

			// Redraw arrows for remaining path
			for (let i = 0; i < selectedPath.length - 1; i++) {
				const fromNode = flowData[selectedPath[i]];
				const toNode = flowData[selectedPath[i + 1]];

				// Determine if it was a yes or no choice
				const choiceType = fromNode.yes === selectedPath[i + 1] ? 'yes' : 'no';
				drawArrow(fromNode.x, fromNode.y, toNode.x, toNode.y, choiceType, true, selectedPath[i]);
			}

			// Recreate previous node with buttons visible
			createNode(previousNodeId);
		}

		// Handle choice
		function handleChoice(nodeId: number, nextId: number, choice: 'yes' | 'no') {
			// Prevent double-click by checking if next node already exists
			if (createdNodes.has(nextId)) {
				return;
			}

			selectedPath.push(nextId);

			// Immediately disable and hide buttons from current node to prevent double-click
			const currentNode = document.getElementById(`node-${nodeId}`);
			const buttons = currentNode?.querySelectorAll('button');
			buttons?.forEach(btn => {
				(btn as HTMLButtonElement).disabled = true;
				btn.style.opacity = '0';
				btn.style.pointerEvents = 'none';
			});

			// Draw arrow
			const from = flowData[nodeId];
			const to = flowData[nextId];
			drawArrow(from.x, from.y, to.x, to.y, choice, true, nodeId);

			// Remove buttons after animation
			setTimeout(() => {
				buttons?.forEach(btn => btn.remove());
			}, 300);

			// Create next node
			setTimeout(() => {
				createNode(nextId);
			}, 300);
		}


		// Start button click handler
		startBtn?.addEventListener('click', () => {
			if (!hasStarted) {
				hasStarted = true;

				// Hide cover screen
				if (coverScreen) {
					coverScreen.style.opacity = '0';
					setTimeout(() => {
						coverScreen.style.display = 'none';
					}, 700);
				}

				// Create first node with delay
				setTimeout(() => {
					createNode(1);
					selectedPath = [1];
				}, 800);
			}
		});

		// Initialize - don't create node yet, wait for start button
		selectedPath = [];

		// Restart button click handler
		restartBtn?.addEventListener('click', () => {
			// Hide restart widget
			if (restartWidget) {
				restartWidget.style.opacity = '0';
				setTimeout(() => {
					restartWidget.classList.add('hidden');
				}, 300);
			}

			// Reset state
			selectedPath = [];
			createdNodes.clear();

			// Clear flowchart
			if (flowchart) flowchart.innerHTML = '';

			// Reset SVG filters
			if (arrowsSvg) arrowsSvg.innerHTML = `
				<defs>
					<filter id="pencil-green">
						<feTurbulence type="fractalNoise" baseFrequency="1.2" numOctaves="5" result="noise" seed="2" />
						<feDisplacementMap in="SourceGraphic" in2="noise" scale="3" xChannelSelector="R" yChannelSelector="G" />
						<feGaussianBlur stdDeviation="0.5" />
					</filter>
					<filter id="pencil-pink">
						<feTurbulence type="fractalNoise" baseFrequency="1.2" numOctaves="5" result="noise" seed="5" />
						<feDisplacementMap in="SourceGraphic" in2="noise" scale="3" xChannelSelector="R" yChannelSelector="G" />
						<feGaussianBlur stdDeviation="0.5" />
					</filter>
					<filter id="crayon-texture">
						<feTurbulence type="fractalNoise" baseFrequency="3" numOctaves="4" result="noise" seed="10" />
						<feDisplacementMap in="SourceGraphic" in2="noise" scale="4" xChannelSelector="R" yChannelSelector="G" />
						<feGaussianBlur stdDeviation="0.4" />
					</filter>
					<filter id="crayon-circle">
						<feTurbulence type="fractalNoise" baseFrequency="3.5" numOctaves="6" result="noise" seed="15" />
						<feDisplacementMap in="SourceGraphic" in2="noise" scale="8" xChannelSelector="R" yChannelSelector="G" />
						<feGaussianBlur stdDeviation="0.8" />
					</filter>
					<filter id="crayon-text">
						<feTurbulence type="fractalNoise" baseFrequency="4" numOctaves="3" result="noise" seed="20" />
						<feDisplacementMap in="SourceGraphic" in2="noise" scale="2" xChannelSelector="R" yChannelSelector="G" />
						<feGaussianBlur stdDeviation="0.2" />
					</filter>
				</defs>
			`;

			// Go to first node directly (no cover screen)
			setTimeout(() => {
				createNode(1);
				selectedPath = [1];
			}, 400);
		});
	</script>
</Layout>
